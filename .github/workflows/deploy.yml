name: Deploy to AWS Lambda

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Build Kotlin/Native executable
        run: |
          chmod +x ./gradlew
          ./gradlew buildBootstrap
      
      - name: Verify build output
        run: |
          ls -lah build/bin/telegram/bootstrapReleaseExecutable/
      
      - name: Create Lambda deployment package
        run: |
          mkdir -p lambda_package
          
          cp bootstrap lambda_package/
          chmod 755 lambda_package/bootstrap
          
          mkdir -p lambda_package/helper
          cp build/bin/telegram/bootstrapReleaseExecutable/bootstrap.kexe lambda_package/main.kexe
          chmod 755 lambda_package/main.kexe
          
          cd lambda_package
          zip -r ../telegram-bot-lambda.zip bootstrap main.kexe
          cd ..
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package
          path: telegram-bot-lambda.zip
      
      - name: Deploy to AWS Lambda
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
        run: |
          pip install awscli
          
          # Check if function exists
          if aws lambda get-function \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --region "$AWS_REGION" 2>/dev/null; then
            
            echo "ðŸ“¦ Function exists, updating code..."
            aws lambda update-function-code \
              --function-name "$LAMBDA_FUNCTION_NAME" \
              --zip-file fileb://telegram-bot-lambda.zip \
              --role "${{ secrets.AWS_LAMBDA_ROLE }}" \
              --region "$AWS_REGION"
          else
            
            echo "ðŸ†• Creating new Lambda function..."
            aws lambda create-function \
              --function-name "$LAMBDA_FUNCTION_NAME" \
              --runtime "provided.al2" \
              --handler "bootstrap" \
              --zip-file fileb://telegram-bot-lambda.zip \
              --role "${{ secrets.AWS_LAMBDA_ROLE }}" \
              --region "$AWS_REGION"
          fi
          
          echo "âœ… Deployment complete!"
      
      - name: Update Lambda environment variables
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          pip install awscli
          
          aws lambda update-function-configuration \
            --function-name "$LAMBDA_FUNCTION_NAME" \
            --environment "Variables={BOT_TOKEN=$BOT_TOKEN}" \
            --region "$AWS_REGION"
      
      - name: Deployment summary
        run: |
          echo "ðŸŽ‰ Deployment Summary"
          echo "Function: ${{ secrets.LAMBDA_FUNCTION_NAME }}"
          echo "Region: ${{ secrets.AWS_REGION }}"
          echo "Package: telegram-bot-lambda.zip"
